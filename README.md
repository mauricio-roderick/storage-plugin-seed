![Reekoh Logo](https://reekoh-my.sharepoint.com/personal/bsicam_reekoh_com/_layouts/15/guestaccess.aspx?guestaccesstoken=CINWTIG%2fK%2beg9Mrlpl3KoXH7PytvmFE%2b%2bsBnm6u%2fWwg%3d&docid=021898c83e05e4d34a5b2573508f21854)

# Storage Plugin Seed

[![Build Status](https://travis-ci.org/Reekoh/storage-plugin-seed.svg)](https://travis-ci.org/Reekoh/storage-plugin-seed)
![Dependencies](https://img.shields.io/david/Reekoh/storage-plugin-seed.svg)
![Dependencies](https://img.shields.io/david/dev/Reekoh/storage-plugin-seed.svg)
![Built With](https://img.shields.io/badge/built%20with-gulp-red.svg)

Storage Plugin seed project for the Reekoh IoT Platform. Helps engineers to start developing storage plugins for the Reekoh IoT Platform.

It is highly recommended that this project is downloaded as starting point everytime you want to create a Storage plugin for Reekoh. 

## Download

```shell
cd /path/to/your/project/folder
git clone https://github.com/Reekoh/storage-plugin-seed .
```

## Overview

Storage Plugins enable you to send and store the data being generated by your devices over to any other database systems (SQL or NoSQL) and file storage systems.

## Platform API

This seed project includes a Platform Object ([via platform.js](https://github.com/benjsicam/storage-plugin-seed/blob/master/platform.js)) which includes all the methods you need to be able to communicate with the Reekoh's core platform.

### notifyReady([callback])
 
Invoking this method is required only once after the Storage has finished it's init phase. This notifies the platform that the Storage is ready to accept data. Once this is called, the platform will start sending data from the devices to this Storage.

__Arguments__

* `callback(err)` {function} - *Optional* A callback which is called when the event is already sent over to the platform.

__Example__

```javascript
platform.once('ready', function (options) {
    // TODO: Initialize your storage via a client connection
    var databaseClient = require('database-client');
    
    databaseClient.connect();
    
    // Once init is done call platform.notifyReady
    platform.notifyReady();
});
```

### notifyClose([callback])

Invoke this method once the Storage has performed a graceful exit i.e. the connections are closed. This notifies the platform that the Storage has exited gracefully.

__Arguments__

* `callback(err)` {function} - *Optional* A callback which is called when the event is already sent over to the platform.

__Example__

```javascript
platform.once('close', function () {
    // TODO: Release all resources. Close all connections
    
    databaseClient.close();
    platform.notifyClose();
});
```

### log(data, [callback])

Invoke this function to log any String object. The log data will be sent to the platform and any Logger plugin connected to the same topology as the Storage will be able receive the log data. For more information about Loggers, see: https://github.com/Reekoh/logger-plugin-seed

__Arguments__

* `data` {string} - The data that needs to be logged. You may pass a JSON String here.
* `callback(err)` {function} - *Optional* A callback which is called when the event is already sent over to the platform.

```javascript
platform.log(JSON.stringify({
    name: 'Reekoh',
    nature: 'Software'
    rating: 10,
    coffee: true
}), function (error) {
    if (error) return console.error(error);
    
    // Perform other tasks.
});
```

### handleException(error, [callback])

Invoke this function to log any Error. The error will be sent to the platform and any Exception Handler plugin connected to the same topology as the Storage will be able receive the error data. For more information about Exception Handlers, see: https://github.com/Reekoh/exception-handler-plugin-seed

__Arguments__

* `error` {error} - The error that needs to be logged.
* `callback(err)` {function} - *Optional* A callback which is called when the message is already sent over to the platform.

```javascript
platform.handleException(new Error('One or more required parameters are missing in the request'), function (error) {
    if (error) return console.error(error);
    
    // Perform other tasks.
});
```

## Platform Events

### 'ready'

Emitted when the platform bootstraps the plugin. The plugin should listen once and execute its init process. Afterwards, platform.notifyReady() should be called to notify the platform that the init process is done.

__Arguments__

* `options` {object} - The options or configuration injected by the platform to the plugin.

__Example__

```javascript
platform.once('ready', function (options) {
    // TODO: Initialize your storage via a client connection
    var databaseClient = require('database-client');
    
    databaseClient.connect();
    
    // Once init is done call platform.notifyReady
    platform.notifyReady();
});
```

**NOTE:** Other options can be configured using the config.json file. This is where you will specify the different parameters to be injected into your Storage plugin.

### 'data'

Emitted when device data is received. This is the event to listen to in order to get real-time data feed from the connected devices.

__Arguments__

* `data` {object} - The data coming from the device represented as JSON Object.

__Example__

```javascript
platform.on('data', function (data) {
   // Insert the data to the database
   databaseClient.insert(data);
});
```

### 'close'

Emitted when the platform shuts down the plugin. The Storage should perform cleanup of the resources on this event.

__Example__

```javascript
platform.on('close', function () {
   databaseClient.close();
   platform.notifyClose();
});
```

## Configuration

As a flexible Internet of Things platform, Reekoh also provides plugin developers a way to request for custom configuration parameters. These custom configuration parameters get injected into the plugin which can then be used to authenticate with the other services or pass in as a parameter. Custom configurations are done through the config.json file.

As an example, External App 1 needs an API Key in order for a client to communicate with it securely. This API Key can be inputted by the user on the Instance Manager console when it is specified on the config.json file.

An example config.json file is detailed below.

__Example__

```javascript
{
    // Will be transformed as a text input on the front-end
    "apikey": {
        "label": "API Key",
        "type": "String",
        "required": true,
        "help": "Kindly specify API Key to use."
    },
    // Will be transformed as a text input on the front-end
    "clientid": {
        "label": "Client ID",
        "type": "Number",
        "required": true,
        "help": "Kindly specify Client ID to use."
    },
    // Will be transformed as a check-box on the front-end
    "perform_handshake": {
        "label": "Perform Handshake",
        "type": "Boolean",
        "required": false,
        "default": true,
        "help": "Check to perform handshake. Default: true"
    },
    // Will be transformed as a select input on the front-end
    "service_type": {
        "label": "Service Type",
        "type": "String",
        "enum": ["Service 1", "Service 2"],
        "required": false,
        "default": "Service 1",
        "help": "(Optional) Kindly select service type. Default: Service 1"
    },
    // Will be transformed as a multi-select input on the front-end
    "service_options": {
        "label": "Service Type",
        "type": "Array",
        "enum": ["Service 1", "Service 2", "Service 3"],
        "required": false,
        "help": "(Optional) Kindly select service options."
    },
    // Will be transformed as a text-area on the front-end
    "description": {
        "label": "Description",
        "type": "Text",
        "required": false,
        "help": "(Optional) Specify description."
    },
    // Will be transformed as a "code text area" on the front-end
    "schema": {
        "label": "Schema",
        "type": "JSON",
        "required": true,
        "help": "(Optional) Specify the schema."
    },
    // Will be transformed as a date-picker on the front-end
    "expire_date": {
        "label": "Expiration Date",
        "type": "Date",
        "required": false,
        "help": "(Optional) Specify Expiration Date."
    },
    // Will be transformed as a date/time picker on the front-end
    "cache_datetime": {
        "label": "Cache Date/Time",
        "type": "DateTime",
        "required": false,
        "help": "(Optional) Specify Cache Expiration."
    }
}
```

Once you've specified custom configuration parameters in your config.json file, they will be translated to a form on the Instance Manager Console. When a user installs the plugin and configure it for use on his/her topology, they will be asked for the configuration parameter inputs.

The values that a user specify in the configuration parameter will then get injected as options in the platform ready event. The plugin can then use the option values to configure a client to connect to another service or app.

__Example__

```javascript
platform.once('ready', function (options) {
   console.log(options.apikey); // As specified in the config.json file
   console.log(options.clientid); // As specified in the config.json file
   console.log(options.perform_handshake); // As specified in the config.json file
   console.log(options.service_type); // As specified in the config.json file
   console.log(options.service_options); // As specified in the config.json file
   console.log(options.description); // As specified in the config.json file
   console.log(options.schema); // As specified in the config.json file
   console.log(options.expire_date); // As specified in the config.json file
   console.log(options.cache_datetime); // As specified in the config.json file
});
```

## Packaging

Plugins need to be a valid Node.js application. A package.json file is required to be included in the plugin package/zip. There are also required details in the package.json file that need to be included. Below is an example of a package.json file with minimum details.

```javascript
{
    "name": "my-reekoh-plugin",
    "version": "1.0.0",
    "author": "ABC Company",
    "main": "app.js"
}
```

A plugin package/zip file should always contain the following files:
 
- package.json
- config.json - if no additional configuration parameters are needed for the plugin to run, just have an empty object as the content


After this, the plugin can now be zipped.

**NOTE:** Only include the contents of your project. Do not zip the root folder of your project.

## Plugin Store

With the Plugin Store, developers will be able to share and monetize the plugins they create and/or drive customers to use your service through Reekoh. Developers are also allowed to create private plugins for their clients if the plugin is specifically tailored to the client's IoT implementation.

The Plugin Store/Manager isn't generally available for developers yet as of Reekoh's Private BETA period. This documentation will be updated once Reekoh opens up the Plugin Store/Manager to developers worldwide.

## Uploading to the Plugin Store

Zipping the plugin files is just one way of creating a plugin/package. Reekoh will be releasing a more robust upload mechanism for developers in the next releases.

For the meantime, .zip files are accepted to be uploaded once the Plugin Store opens.

## Tests

It is recommended that you write your own tests for your plugins. Included in this seed project is a sample test which you can use as starting point to test your plugins.

## Help and Support

You are always welcome to ask us about anything related to plugin development. You may [send us an email](mailto:help@reekoh.com) anytime.
